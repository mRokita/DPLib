

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Getting Started &mdash; DPLib 1.6 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="README" href="includeme.html" />
    <link rel="prev" title="LICENSE" href="includelicense.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> DPLib
          

          
          </a>

          
            
            
              <div class="version">
                1.6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="includelicense.html">LICENSE</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#first-steps">First steps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#available-event-handlers">Available event handlers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#waiting-for-future-events">Waiting for future events</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#available-coroutines">Available coroutines</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#examples">Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#map-settings">Map settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="#map-elim-script">Map elim script</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spawnkill-message">Spawnkill message</a></li>
<li class="toctree-l3"><a class="reference internal" href="#streak">Streak</a></li>
<li class="toctree-l3"><a class="reference internal" href="#server-manager">Server manager</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="includeme.html">README</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">DPLib</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Getting Started</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/gettingstarted.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="getting-started">
<h1>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>DPLib is a Python library that makes you able to write scripts that react on some in-game events</p>
</div>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/mRokita/DPLib.git
<span class="nb">cd</span> DPLib
python3 -m pip install DPLib <span class="c1"># Only python 3 is supported</span>
</pre></div>
</div>
</div>
<div class="section" id="first-steps">
<h2>First steps<a class="headerlink" href="#first-steps" title="Permalink to this headline">¶</a></h2>
<p>This code is a basic example of how to use DPLib. It uses all the currently available events.
You should definitely play around with it. Simply edit the third line to match your server’s config and run it!</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># DPLib - Asynchronous bot framework for Digital Paint: Paintball 2 servers</span>
<span class="c1"># Copyright (C) 2017  Michał Rokita</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Affero General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Affero General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Affero General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kn">from</span> <span class="nn">dplib.server</span> <span class="k">import</span> <span class="n">Server</span>


<span class="n">s</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">27910</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;C:\Games\Paintball2\pball\qconsole27910.log&#39;</span><span class="p">,</span> <span class="n">rcon_password</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>


<span class="nd">@s</span><span class="o">.</span><span class="n">event</span>
<span class="k">def</span> <span class="nf">on_chat</span><span class="p">(</span><span class="n">nick</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Chat message. Nick: </span><span class="si">{0}</span><span class="s1">, Message: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nick</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>


<span class="nd">@s</span><span class="o">.</span><span class="n">event</span>
<span class="k">def</span> <span class="nf">on_team_switched</span><span class="p">(</span><span class="n">nick</span><span class="p">,</span> <span class="n">old_team</span><span class="p">,</span> <span class="n">new_team</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Team switched. Nick: </span><span class="si">{0}</span><span class="s1">, Old team: </span><span class="si">{1}</span><span class="s1">, New team: </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nick</span><span class="p">,</span> <span class="n">old_team</span><span class="p">,</span> <span class="n">new_team</span><span class="p">))</span>


<span class="nd">@s</span><span class="o">.</span><span class="n">event</span>
<span class="k">def</span> <span class="nf">on_round_started</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Round started...&#39;</span><span class="p">)</span>


<span class="nd">@s</span><span class="o">.</span><span class="n">event</span>
<span class="k">def</span> <span class="nf">on_elim</span><span class="p">(</span><span class="n">killer_nick</span><span class="p">,</span> <span class="n">killer_weapon</span><span class="p">,</span> <span class="n">victim_nick</span><span class="p">,</span> <span class="n">victim_weapon</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Elimination. Killer</span><span class="se">\&#39;</span><span class="s1">s nick: </span><span class="si">{0}</span><span class="s1">, Killer</span><span class="se">\&#39;</span><span class="s1">s weapon: </span><span class="si">{1}</span><span class="s1">, Victim</span><span class="se">\&#39;</span><span class="s1">s nick: </span><span class="si">{2}</span><span class="s1">, Victim</span><span class="se">\&#39;</span><span class="s1">s weapon: </span><span class="si">{3}</span><span class="s1">&#39;</span>
        <span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">killer_nick</span><span class="p">,</span> <span class="n">killer_weapon</span><span class="p">,</span> <span class="n">victim_nick</span><span class="p">,</span> <span class="n">victim_weapon</span>
    <span class="p">))</span>


<span class="nd">@s</span><span class="o">.</span><span class="n">event</span>
<span class="k">def</span> <span class="nf">on_respawn</span><span class="p">(</span><span class="n">team</span><span class="p">,</span> <span class="n">nick</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Respawn. Nick: </span><span class="si">{0}</span><span class="s1">, Team: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nick</span><span class="p">,</span> <span class="n">team</span><span class="p">))</span>


<span class="nd">@s</span><span class="o">.</span><span class="n">event</span>
<span class="k">def</span> <span class="nf">on_entrance</span><span class="p">(</span><span class="n">nick</span><span class="p">,</span> <span class="n">build</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Entrance. Nick: </span><span class="si">{0}</span><span class="s1">, Build: </span><span class="si">{1}</span><span class="s1">, Address: </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">nick</span><span class="p">,</span> <span class="n">build</span><span class="p">,</span> <span class="n">addr</span>
    <span class="p">))</span>


<span class="nd">@s</span><span class="o">.</span><span class="n">event</span>
<span class="k">def</span> <span class="nf">on_elim_teams_flag</span><span class="p">(</span><span class="n">team</span><span class="p">,</span> <span class="n">nick</span><span class="p">,</span> <span class="n">points</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Points for posession of eliminated teams flag. Team: </span><span class="si">{0}</span><span class="s1">, Nick: </span><span class="si">{1}</span><span class="s1">, Points: </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">team</span><span class="p">,</span> <span class="n">nick</span><span class="p">,</span> <span class="n">points</span>
    <span class="p">))</span>


<span class="nd">@s</span><span class="o">.</span><span class="n">event</span>
<span class="k">def</span> <span class="nf">on_flag_captured</span><span class="p">(</span><span class="n">team</span><span class="p">,</span> <span class="n">nick</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Flag captured. Team: </span><span class="si">{0}</span><span class="s1">, Nick: </span><span class="si">{1}</span><span class="s1">, Flag: </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">team</span><span class="p">,</span> <span class="n">nick</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>


<span class="nd">@s</span><span class="o">.</span><span class="n">event</span>
<span class="k">def</span> <span class="nf">on_game_end</span><span class="p">(</span><span class="n">score_blue</span><span class="p">,</span> <span class="n">score_red</span><span class="p">,</span> <span class="n">score_yellow</span><span class="p">,</span> <span class="n">score_purple</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Game ended. Blue:</span><span class="si">{}</span><span class="s1"> Red:</span><span class="si">{}</span><span class="s1"> Yellow:</span><span class="si">{}</span><span class="s1"> Purple:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">score_blue</span><span class="p">,</span> <span class="n">score_red</span><span class="p">,</span> <span class="n">score_yellow</span><span class="p">,</span> <span class="n">score_purple</span>
    <span class="p">))</span>


<span class="nd">@s</span><span class="o">.</span><span class="n">event</span>
<span class="k">def</span> <span class="nf">on_mapchange</span><span class="p">(</span><span class="n">mapname</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Map changed. Mapname: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mapname</span><span class="p">))</span>


<span class="nd">@s</span><span class="o">.</span><span class="n">event</span>
<span class="k">def</span> <span class="nf">on_namechange</span><span class="p">(</span><span class="n">old_nick</span><span class="p">,</span> <span class="n">new_nick</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Name changed. Old nick: </span><span class="si">{}</span><span class="s1"> New nick: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_nick</span><span class="p">,</span> <span class="n">new_nick</span><span class="p">))</span>


<span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get_status</span><span class="p">())</span>
<span class="n">s</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="available-event-handlers">
<h3>Available event handlers<a class="headerlink" href="#available-event-handlers" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.on_elim" title="dplib.server.Server.on_elim"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.on_elim()</span></code></a></p></li>
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.on_entrance" title="dplib.server.Server.on_entrance"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.on_entrance()</span></code></a></p></li>
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.on_respawn" title="dplib.server.Server.on_respawn"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.on_respawn()</span></code></a></p></li>
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.on_elim_teams_flag" title="dplib.server.Server.on_elim_teams_flag"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.on_elim_teams_flag()</span></code></a></p></li>
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.on_team_switched" title="dplib.server.Server.on_team_switched"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.on_team_switched()</span></code></a></p></li>
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.on_round_started" title="dplib.server.Server.on_round_started"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.on_round_started()</span></code></a></p></li>
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.on_flag_captured" title="dplib.server.Server.on_flag_captured"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.on_flag_captured()</span></code></a></p></li>
<li><p><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.on_message()</span></code></p></li>
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.on_game_end" title="dplib.server.Server.on_game_end"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.on_game_end()</span></code></a></p></li>
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.on_mapchange" title="dplib.server.Server.on_mapchange"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.on_mapchange()</span></code></a></p></li>
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.on_namechange" title="dplib.server.Server.on_namechange"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.on_namechange()</span></code></a></p></li>
</ul>
</div>
</div>
<div class="section" id="waiting-for-future-events">
<h2>Waiting for future events<a class="headerlink" href="#waiting-for-future-events" title="Permalink to this headline">¶</a></h2>
<p>DPLib uses Python’s asyncio module so you can wait for incoming events without blocking the whole script.</p>
<p>Here’s a script that uses these ‘magic’ coroutines.</p>
<p>It’s a simple spawnkill protection system, it waits for 2 seconds after respawn for elimination event and when the newly respawned player gets killed within these 2 seconds, the spawnkiller gets a warning. After 4 spawnkills she/he gets kicked from the server.</p>
<p>Check out the 10th line.</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># DPLib - Asynchronous bot framework for Digital Paint: Paintball 2 servers</span>
<span class="c1"># Copyright (C) 2017  Michał Rokita</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Affero General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Affero General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Affero General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>

<span class="kn">from</span> <span class="nn">dplib.server</span> <span class="k">import</span> <span class="n">Server</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">27910</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;C:\Games\Paintball2\pball\qconsole27910.log&#39;</span><span class="p">,</span> <span class="n">rcon_password</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>

<span class="n">spawnkills</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">spawnkill_last_times</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

<span class="nd">@s</span><span class="o">.</span><span class="n">event</span>
<span class="k">def</span> <span class="nf">on_respawn</span><span class="p">(</span><span class="n">team</span><span class="p">,</span> <span class="n">nick</span><span class="p">):</span>
    <span class="n">kill</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">s</span><span class="o">.</span><span class="n">wait_for_elim</span><span class="p">(</span><span class="n">victim_nick</span><span class="o">=</span><span class="n">nick</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">kill</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">kill</span><span class="p">[</span><span class="s1">&#39;killer_nick&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">spawnkills</span> <span class="ow">or</span> <span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">spawnkill_last_times</span><span class="p">[</span><span class="n">kill</span><span class="p">[</span><span class="s1">&#39;killer_nick&#39;</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">spawnkills</span><span class="p">[</span><span class="n">kill</span><span class="p">[</span><span class="s1">&#39;killer_nick&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">spawnkills</span><span class="p">[</span><span class="n">kill</span><span class="p">[</span><span class="s1">&#39;killer_nick&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">spawnkill_last_times</span><span class="p">[</span><span class="n">kill</span><span class="p">[</span><span class="s1">&#39;killer_nick&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">s</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{C}</span><span class="s1">9</span><span class="si">%s</span><span class="s1">, </span><span class="si">{C}</span><span class="s1">A</span><span class="si">{U}</span><span class="s1">STOP SPAWNKILLING</span><span class="si">{U}</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">kill</span><span class="p">[</span><span class="s1">&#39;killer_nick&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">spawnkills</span><span class="p">[</span><span class="n">kill</span><span class="p">[</span><span class="s1">&#39;killer_nick&#39;</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">s</span><span class="o">.</span><span class="n">kick</span><span class="p">(</span><span class="n">nick</span><span class="o">=</span><span class="n">kill</span><span class="p">[</span><span class="s1">&#39;killer_nick&#39;</span><span class="p">])</span>
<span class="n">s</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="available-coroutines">
<h3>Available coroutines<a class="headerlink" href="#available-coroutines" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.wait_for_elim" title="dplib.server.Server.wait_for_elim"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.wait_for_elim()</span></code></a></p></li>
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.wait_for_entrance" title="dplib.server.Server.wait_for_entrance"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.wait_for_entrance()</span></code></a></p></li>
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.wait_for_respawn" title="dplib.server.Server.wait_for_respawn"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.wait_for_respawn()</span></code></a></p></li>
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.wait_for_elim_teams_flag" title="dplib.server.Server.wait_for_elim_teams_flag"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.wait_for_elim_teams_flag()</span></code></a></p></li>
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.wait_for_team_switched" title="dplib.server.Server.wait_for_team_switched"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.wait_for_team_switched()</span></code></a></p></li>
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.wait_for_round_started" title="dplib.server.Server.wait_for_round_started"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.wait_for_round_started()</span></code></a></p></li>
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.wait_for_flag_captured" title="dplib.server.Server.wait_for_flag_captured"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.wait_for_flag_captured()</span></code></a></p></li>
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.wait_for_message" title="dplib.server.Server.wait_for_message"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.wait_for_message()</span></code></a></p></li>
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.wait_for_game_end" title="dplib.server.Server.wait_for_game_end"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.wait_for_game_end()</span></code></a></p></li>
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.wait_for_mapchange" title="dplib.server.Server.wait_for_mapchange"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.wait_for_mapchange()</span></code></a></p></li>
<li><p><a class="reference internal" href="source/dplib.html#dplib.server.Server.wait_for_namechange" title="dplib.server.Server.wait_for_namechange"><code class="xref py py-func docutils literal notranslate"><span class="pre">dplib.server.Server.wait_for_namechange()</span></code></a></p></li>
</ul>
</div>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<div class="section" id="map-settings">
<h3>Map settings<a class="headerlink" href="#map-settings" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># DPLib - Asynchronous bot framework for Digital Paint: Paintball 2 servers</span>
<span class="c1"># Copyright (C) 2017  Michał Rokita</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Affero General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Affero General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Affero General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="kn">from</span> <span class="nn">asyncio</span> <span class="k">import</span> <span class="n">sleep</span>

<span class="kn">from</span> <span class="nn">dplib.server</span> <span class="k">import</span> <span class="n">Server</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">27911</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;C:\Games\Paintball2\pball\qconsole27911.log&#39;</span><span class="p">,</span> <span class="n">rcon_password</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>

<span class="n">map_settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;airtime&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="s1">&#39;set elim 10;set timelimit 10;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{C}</span><span class="s1">9Special settings for airtime </span><span class="si">{C}</span><span class="s1">Aenabled&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;shazam33&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="s1">&#39;set elim 10;set timelimit 10;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{C}</span><span class="s1">9Special settings for shazam33 </span><span class="si">{C}</span><span class="s1">Aenabled&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;default_settings&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="s1">&#39;set elim 20;set timelimit 20;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{C}</span><span class="s1">9No special settings for map </span><span class="si">{I}</span><span class="s1">&lt;mapname&gt;</span><span class="si">{I}</span><span class="s1">, using defaults&#39;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@s</span><span class="o">.</span><span class="n">event</span>
<span class="k">def</span> <span class="nf">on_mapchange</span><span class="p">(</span><span class="n">mapname</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">mapname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">map_settings</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">map_settings</span><span class="p">[</span><span class="s1">&#39;default_settings&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">map_settings</span><span class="p">[</span><span class="n">mapname</span><span class="p">]</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">mapname</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;mapname&gt;&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">command</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">rcon</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<span class="n">s</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="map-elim-script">
<h3>Map elim script<a class="headerlink" href="#map-elim-script" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># DPLib - Asynchronous bot framework for Digital Paint: Paintball 2 servers</span>
<span class="c1"># Copyright (C) 2017  Michał Rokita</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Affero General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Affero General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Affero General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kn">from</span> <span class="nn">dplib.server</span> <span class="k">import</span> <span class="n">Server</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">27910</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;C:\Games\Paintball2\pball\qconsole27910.log&#39;</span><span class="p">,</span> <span class="n">rcon_password</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>

<span class="n">elim_active</span> <span class="o">=</span> <span class="kc">False</span>

<span class="nd">@s</span><span class="o">.</span><span class="n">event</span>
<span class="k">def</span> <span class="nf">on_chat</span><span class="p">(</span><span class="n">nick</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">elim_active</span>
    <span class="k">if</span> <span class="n">message</span> <span class="o">==</span> <span class="s1">&#39;!map elim&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">elim_active</span><span class="p">:</span>
        <span class="n">elim_active</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">maps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;beta/wobluda_fix&#39;</span><span class="p">,</span> <span class="s1">&#39;beta/daylight_b1&#39;</span><span class="p">,</span> <span class="s1">&#39;airtime&#39;</span><span class="p">]</span>
        <span class="n">s</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{C}</span><span class="s1">AType </span><span class="se">\&#39;</span><span class="s1">!elim &lt;mapname&gt;</span><span class="se">\&#39;</span><span class="s1"> to eliminate a map.&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">maps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{C}</span><span class="s1">9Available maps: &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">maps</span><span class="p">))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">s</span><span class="o">.</span><span class="n">wait_for_message</span><span class="p">(</span><span class="n">check</span><span class="o">=</span><span class="k">lambda</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;!elim &#39;</span><span class="p">))</span>
            <span class="n">mapname</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;!elim &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mapname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">maps</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{C}</span><span class="s1">9Invalid map.&#39;</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{C}</span><span class="s1">9Available maps: &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">maps</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maps</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mapname</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">rcon</span><span class="p">(</span><span class="s1">&#39;sv newmap &#39;</span><span class="o">+</span><span class="n">maps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">elim_active</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">s</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="spawnkill-message">
<h3>Spawnkill message<a class="headerlink" href="#spawnkill-message" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># DPLib - Asynchronous bot framework for Digital Paint: Paintball 2 servers</span>
<span class="c1"># Copyright (C) 2017  Michał Rokita</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Affero General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Affero General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Affero General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kn">from</span> <span class="nn">dplib.server</span> <span class="k">import</span> <span class="n">Server</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">27910</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;C:\Games\Paintball2\pball\qconsole27910.log&#39;</span><span class="p">,</span> <span class="n">rcon_password</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>

<span class="nd">@s</span><span class="o">.</span><span class="n">event</span>
<span class="k">def</span> <span class="nf">on_respawn</span><span class="p">(</span><span class="n">team</span><span class="p">,</span> <span class="n">nick</span><span class="p">):</span>
    <span class="n">kill</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">s</span><span class="o">.</span><span class="n">wait_for_elim</span><span class="p">(</span><span class="n">victim_nick</span><span class="o">=</span><span class="n">nick</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kill</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">get_ingame_info</span><span class="p">(</span><span class="n">kill</span><span class="p">[</span><span class="s1">&#39;killer_nick&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dplogin</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{C}</span><span class="s1">9</span><span class="si">%s</span><span class="s1">, </span><span class="si">{C}</span><span class="s1">A</span><span class="si">{U}</span><span class="s1">STOP SPAWNKILLING</span><span class="si">{U}</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">kill</span><span class="p">[</span><span class="s1">&#39;killer_nick&#39;</span><span class="p">])</span>

<span class="n">s</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="streak">
<h3>Streak<a class="headerlink" href="#streak" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># DPLib - Asynchronous bot framework for Digital Paint: Paintball 2 servers</span>
<span class="c1"># Copyright (C) 2017  Michał Rokita</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Affero General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Affero General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Affero General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kn">import</span> <span class="nn">asyncio</span>

<span class="kn">from</span> <span class="nn">dplib.server</span> <span class="k">import</span> <span class="n">Server</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">27910</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;C:\Games\Paintball2\pball\qconsole27910.log&#39;</span><span class="p">,</span> <span class="n">rcon_password</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>


<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<span class="k">def</span> <span class="nf">streak</span><span class="p">(</span><span class="n">killer_nick</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">killer_nick</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="n">s</span><span class="o">.</span><span class="n">wait_for_elim</span><span class="p">(</span><span class="n">killer_nick</span><span class="o">=</span><span class="n">killer_nick</span><span class="p">)</span>


<span class="nd">@s</span><span class="o">.</span><span class="n">event</span>
<span class="k">def</span> <span class="nf">on_elim</span><span class="p">(</span><span class="n">killer_nick</span><span class="p">,</span> <span class="n">killer_weapon</span><span class="p">,</span> <span class="n">victim_nick</span><span class="p">,</span> <span class="n">victim_weapon</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">streak</span><span class="p">(</span><span class="n">killer_nick</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{U}%s</span><span class="s1"> ZABUJCA!</span><span class="si">{U}</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">killer_nick</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Timeout for &#39;</span><span class="o">+</span> <span class="n">killer_nick</span><span class="p">)</span>

<span class="n">s</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="server-manager">
<h3>Server manager<a class="headerlink" href="#server-manager" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python3</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Process</span>
<span class="kn">from</span> <span class="nn">shlex</span> <span class="k">import</span> <span class="n">quote</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">Thread</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span><span class="p">,</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">pty</span>
<span class="kn">import</span> <span class="nn">aioftp</span>

<span class="kn">from</span> <span class="nn">_socket</span> <span class="k">import</span> <span class="n">timeout</span>

<span class="kn">from</span> <span class="nn">dplib.server</span> <span class="k">import</span> <span class="n">Server</span><span class="p">,</span> <span class="n">ServerEvent</span>

<span class="c1"># -------------- BEGIN CONFIG SECTION ----------------</span>

<span class="n">LAUNCH_TIMEOUT</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">PAINTBALL_DIR</span> <span class="o">=</span> <span class="s1">&#39;/home/paintball/paintball2/&#39;</span>

<span class="n">SERVERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;speed&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;enabled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;startup_cvars&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;hostname&#39;</span><span class="p">:</span> <span class="s1">&#39;FALUBAZ/devol&#39;</span><span class="p">,</span>
            <span class="s1">&#39;public&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">27911</span><span class="p">,</span>
            <span class="s1">&#39;flagcapendsround&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;elim&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;rcon_password&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span>
        <span class="p">},</span>
        <span class="s1">&#39;startup_commands&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;setmaster&#39;</span><span class="p">,</span> <span class="s1">&#39;dplogin.com&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="s1">&#39;dodgeball&#39;</span><span class="p">],</span>
        <span class="p">],</span>
        <span class="s1">&#39;event_rcons&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">ServerEvent</span><span class="o">.</span><span class="n">CHAT</span><span class="p">:</span> <span class="s1">&#39;say on_chat&#39;</span><span class="p">,</span>
            <span class="n">ServerEvent</span><span class="o">.</span><span class="n">ELIM</span><span class="p">:</span> <span class="s1">&#39;say on_elim&#39;</span><span class="p">,</span>
            <span class="n">ServerEvent</span><span class="o">.</span><span class="n">RESPAWN</span><span class="p">:</span> <span class="s1">&#39;say on_respawn&#39;</span><span class="p">,</span>
            <span class="n">ServerEvent</span><span class="o">.</span><span class="n">ENTRANCE</span><span class="p">:</span> <span class="s1">&#39;say Hello, </span><span class="si">{nick}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">ServerEvent</span><span class="o">.</span><span class="n">FLAG_CAPTURED</span><span class="p">:</span> <span class="s1">&#39;say on_flag_captured&#39;</span><span class="p">,</span>
            <span class="n">ServerEvent</span><span class="o">.</span><span class="n">ELIM_TEAMS_FLAG</span><span class="p">:</span> <span class="s1">&#39;say on_elim_teams_flag&#39;</span><span class="p">,</span>
            <span class="n">ServerEvent</span><span class="o">.</span><span class="n">ROUND_STARTED</span><span class="p">:</span> <span class="s1">&#39;say on_round_started&#39;</span><span class="p">,</span>
            <span class="n">ServerEvent</span><span class="o">.</span><span class="n">TEAM_SWITCHED</span><span class="p">:</span> <span class="s1">&#39;say on_team_switched&#39;</span><span class="p">,</span>
            <span class="n">ServerEvent</span><span class="o">.</span><span class="n">GAME_END</span><span class="p">:</span> <span class="s1">&#39;say on_game_end&#39;</span><span class="p">,</span>
            <span class="n">ServerEvent</span><span class="o">.</span><span class="n">MAPCHANGE</span><span class="p">:</span> <span class="s1">&#39;say on_mapchange&#39;</span><span class="p">,</span>
            <span class="n">ServerEvent</span><span class="o">.</span><span class="n">NAMECHANGE</span><span class="p">:</span> <span class="s1">&#39;say on_namechange&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;event_lambdas&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">ServerEvent</span><span class="o">.</span><span class="n">CHAT</span><span class="p">:</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">kwargs</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># -------------- END CONFIG SECTION ----------------</span>

<span class="n">managed_servers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>




<span class="k">def</span> <span class="nf">get_map_download_path</span><span class="p">(</span><span class="n">mapname</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PAINTBALL_DIR</span><span class="p">,</span> <span class="s1">&#39;pball&#39;</span><span class="p">,</span> <span class="s1">&#39;maps&#39;</span><span class="p">,</span> <span class="n">mapname</span> <span class="o">+</span> <span class="s1">&#39;.bsp&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_map_server_path</span><span class="p">(</span><span class="n">mapname</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;pball&#39;</span><span class="p">,</span> <span class="s1">&#39;maps&#39;</span><span class="p">,</span> <span class="n">mapname</span> <span class="o">+</span> <span class="s1">&#39;.bsp&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ManagedServer</span><span class="p">(</span><span class="n">Server</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_id</span> <span class="o">=</span> <span class="n">server_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pty_master</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pty_slave</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_chat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nick</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;!map &#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mapname</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;!map &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">get_map_download_path</span><span class="p">(</span><span class="n">mapname</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{C}</span><span class="s2">9Map </span><span class="si">{C}</span><span class="s2">A&quot;</span> <span class="o">+</span> <span class="n">mapname</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{C}</span><span class="s2">9 is already on the server, changing&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_map</span><span class="p">(</span><span class="n">mapname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">async</span> <span class="k">with</span> <span class="n">aioftp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="s2">&quot;ic3y.de&quot;</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
                    <span class="k">if</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">get_map_server_path</span><span class="p">(</span><span class="n">mapname</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">say</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="si">{C}</span><span class="s2">9Downloading </span><span class="si">{C}</span><span class="s2">A&quot;</span> <span class="o">+</span> <span class="n">mapname</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{C}</span><span class="s2">9 from ic3y.de...&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">get_map_server_path</span><span class="p">(</span><span class="n">mapname</span><span class="p">))</span>
                        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">get_map_server_path</span><span class="p">(</span><span class="n">mapname</span><span class="p">),</span> <span class="n">get_map_download_path</span><span class="p">(</span><span class="n">mapname</span><span class="p">),</span> <span class="n">write_into</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">say</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="si">{C}</span><span class="s2">A&quot;</span> <span class="o">+</span> <span class="n">mapname</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{C}</span><span class="s2">9 has been downloaded successfully, changing map...&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">new_map</span><span class="p">(</span><span class="n">mapname</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">say</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="si">{C}</span><span class="s2">9 Map </span><span class="si">{C}</span><span class="s2">A&quot;</span> <span class="o">+</span> <span class="n">mapname</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{C}</span><span class="s2">9 is not available at ic3y.de&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">new_map</span><span class="p">(</span><span class="n">mapname</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">running</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">start_event_service</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;make_secure&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_event_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">event_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;event_rcons&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rcon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;event_rcons&#39;</span><span class="p">][</span><span class="n">event_type</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">event_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;event_lambdas&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;event_lambdas&#39;</span><span class="p">][</span><span class="n">event_type</span><span class="p">](</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">await</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">event_type</span><span class="p">])(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">handle</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_event_handler</span><span class="p">(</span><span class="n">event_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kill_running_process</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[WARNING] Skipping server </span><span class="si">%s</span><span class="s1"> - &quot;enabled&quot; is False&#39;</span> <span class="o">%</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">server_id</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">master</span><span class="p">,</span> <span class="n">slave</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">openpty</span><span class="p">()</span>

        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_run_command</span><span class="p">()),</span>
                                   <span class="n">stdout</span><span class="o">=</span><span class="n">slave</span><span class="p">,</span>
                                   <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
                                   <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
                                   <span class="n">preexec_fn</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">setsid</span><span class="p">,</span>
                                   <span class="n">shell</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">pid</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ManagedServer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">hostname</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;startup_cvars&#39;</span><span class="p">][</span><span class="s1">&#39;port&#39;</span><span class="p">],</span>
            <span class="n">rcon_password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;startup_cvars&#39;</span><span class="p">][</span><span class="s1">&#39;rcon_password&#39;</span><span class="p">],</span>
            <span class="n">pty_master</span><span class="o">=</span><span class="n">master</span>
        <span class="p">)</span>
        <span class="n">managed_servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">port</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_secure</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_event_service</span><span class="p">()</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">port</span> <span class="ow">and</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&lt;</span> <span class="n">LAUNCH_TIMEOUT</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cvar</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">port</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[ERROR] Couldn&#39;t start server </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SUCCESS] Server </span><span class="si">%s</span><span class="s2"> is running on 127.0.0.1:</span><span class="si">%s</span><span class="s2">. PID: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_id</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_run_command</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;./paintball2 +set dedicated 1&#39;</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;startup_cvars&#39;</span><span class="p">]:</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="s1">&#39; +set </span><span class="si">%s</span><span class="s1"> &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">quote</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">quote</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;startup_cvars&#39;</span><span class="p">][</span><span class="n">v</span><span class="p">])))</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;startup_commands&#39;</span><span class="p">]:</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="s1">&#39; +&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">quote</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">c</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pid</span>

    <span class="nd">@pid</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__pid</span> <span class="o">=</span> <span class="n">pid</span>
        <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.pid&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_id</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__pid</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_listening</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rcon</span><span class="p">(</span><span class="s2">&quot;quit&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kill_own_process</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="ne">ConnectionError</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">kill_own_process</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kill_running_process</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[INFO] Killed server </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_id</span> <span class="ow">in</span> <span class="n">managed_servers</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">managed_servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">kill_running_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.pid&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_id</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fo</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">kill_own_process</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_pid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">kill_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">killpg</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Kill&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">ProcessLookupError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fail&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">run_servers</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">SERVERS</span><span class="p">:</span>
        <span class="n">managed_server</span> <span class="o">=</span> <span class="n">ManagedServer</span><span class="p">(</span><span class="n">server_id</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">SERVERS</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
        <span class="n">managed_server</span><span class="o">.</span><span class="n">start_process</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">kill_all</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">managed_servers</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="n">s</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">PAINTBALL_DIR</span><span class="p">)</span>
        <span class="n">run_servers</span><span class="p">()</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Enter &#39;quit&#39; to kill all servers&quot;</span><span class="p">)</span>
        <span class="n">wait</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">managed_servers</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">is_listening</span><span class="p">:</span>
                <span class="n">wait</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="nb">input</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;quit&#39;</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">kill_all</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
                <span class="k">pass</span>
<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
    <span class="n">kill_all</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">kill_all</span><span class="p">()</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">kill_all</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="includeme.html" class="btn btn-neutral float-right" title="README" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="includelicense.html" class="btn btn-neutral float-left" title="LICENSE" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2018, Michał Rokita

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>